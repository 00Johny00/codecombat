<script>
  import api from 'core/api'
  import avatarSelectionScreen from '../../avatar-selector/PageAvatarSelector'
  import interactivesComponent from '../../interactive/PageInteractive'
  import cinematicsComponent from '../../cinematic/PageCinematic'
  import cutsceneVideoComponent from '../../cutscene/PageCutscene'
  import { defaultCodeLanguage } from 'ozaria/site/common/ozariaUtils'
  import utils from 'core/utils'
  import modalTransition from 'ozaria/site/components/common/ModalTransition'
  import { mapMutations } from 'vuex'
  import { log } from 'ozaria/site/common/logger'

  export default Vue.extend({
    components: {
      'interactives-component': interactivesComponent,
      'cinematics-component': cinematicsComponent,
      'cutscene-video-component': cutsceneVideoComponent,
      'avatar-selection-screen': avatarSelectionScreen,
      'modal-transition': modalTransition
    },
    props: {
      introLevelIdOrSlug: {
        type: String,
        required: true,
        default: ''
      },
      courseInstanceId: {
        type: String,
        default: undefined
      },
      codeLanguage: {
        type: String,
        default: undefined
      },
      courseId: {
        type: String,
        default: undefined
      }
    },
    data: () => ({
      introLevelData: {},
      introLevelSession: {},
      introContent: [],
      currentContent: {},
      currentContentId: '',
      currentIndex: 0,
      language: '',
      dataLoaded: false,
      showVictoryModal: false,
      introLevelComplete: false,
      currentContentData: {},
      reloadKey: {}
    }),
    watch: {
      introLevelIdOrSlug: async function () {
        await this.loadIntroLevel()
      }
    },
    async created () {
      await this.loadIntroLevel()
      if (!me.isSessionless()) this.sessionPlaytimeIntervalId = setInterval(this.updateContentPlaytime, 1000)
    },
    async beforeDestroy () {
      if (this.sessionPlaytimeIntervalId) {
        clearInterval(this.sessionPlaytimeIntervalId)
        this.sessionPlaytimeIntervalId = null
      }
      await this.saveLevelSession()
    },
    methods: {
      ...mapMutations({
        setUnitMapUrlDetails: 'layoutChrome/setUnitMapUrlDetails',
        setCurrentCampaignId: 'campaigns/setCurrentCampaignId'
      }),
      loadIntroLevel: async function () {
        this.dataLoaded = false

        // Reading query params because this is rendered via backbone router and cannot be directly passed in as props
        // They need to be in a specific order in the url to read and send them as props directy from backbone router, hence using query params here.
        this.courseInstanceId = this.courseInstanceId || utils.getQueryVariable('course-instance')
        this.codeLanguage = this.codeLanguage || utils.getQueryVariable('codeLanguage')
        this.courseId = this.courseId || utils.getQueryVariable('course')
        try {
          this.introLevelData = await api.levels.getByIdOrSlug(this.introLevelIdOrSlug)
          if (me.isSessionless()) { // not saving progress/session for teachers
            // TODO: why do we need this.language, instead of setting this.codeLanguage to default if necessary?
            this.language = this.codeLanguage || defaultCodeLanguage
          } else {
            const sessionOptions = {
              courseInstanceId: this.courseInstanceId,
              course: this.courseId,
              codeLanguage: this.codeLanguage || defaultCodeLanguage // used for non-classroom anonymous users
            }
            this.introLevelSession = await api.levels.upsertSession(this.introLevelIdOrSlug, sessionOptions)
            this.language = this.introLevelSession.codeLanguage
          }

          this.introContent = this.introLevelData.introContent
          // Set current campaign id and unit map URL details for acodus chrome
          this.setCurrentCampaignId(this.introLevelData.campaign)
          this.setUnitMapUrlDetails({ courseId: this.courseId, courseInstanceId: this.courseInstanceId })
        } catch (err) {
          console.error('Error in creating data for intro level', err)
          // TODO handle_error_ozaria
          noty({ text: 'Error in creating data for intro level', type: 'error', timeout: 2000 })
          return
        }
        if (me.isSessionless()) {
          this.currentIndex = parseInt(utils.getQueryVariable('intro-content')) || 0
          if (this.currentIndex >= this.introContent.length) {
            console.error('Invalid content index')
            // TODO handle_error_ozaria
            noty({ text: 'Error in creating data for intro level', type: 'error', timeout: 2000 })
            return
          }
        } else { // Assign first content in the sequence to this.currentContent
          this.currentIndex = 0
        }
        this.currentContent = this.introContent[this.currentIndex]
        this.setCurrentContentId(this.currentContent)
        this.dataLoaded = true
      },
      onContentCompleted: async function (data) {
        this.currentContentData = data || {}
        this.currentContentData.contentType = this.currentContent.type
        if (this.currentIndex + 1 === this.introContent.length) {
          this.introLevelComplete = true
          await this.setIntroLevelComplete()
        }

        if (this.currentContent.type === 'avatarSelectionScreen') {
          // Skip the modal for avatar selector
          await this.goToNextContent()
        } else {
          this.showVictoryModal = true
        }
      },
      onReplayVictoryModal: function (data) {
        this.showVictoryModal = false
        this.setCurrentContentId(this.currentContent)
      },
      goToNextContent: async function () {
        this.showVictoryModal = false
        this.currentIndex++
        if (this.currentIndex < this.introContent.length) { // increment current content
          this.currentContent = this.introContent[this.currentIndex]
          this.setCurrentContentId(this.currentContent)
        }
        await this.saveLevelSession() // Save latest content playtime data
      },
      saveLevelSession: async function () {
        if (me.isSessionless() || !this.introLevelSession) return // not saving progress/session for teachers
        try {
          await api.levelSessions.update(this.introLevelSession)
        } catch (err) {
          log(`Error saving intro level session ${this.introLevelSession._id}`, err, 'error')
          // TODO handle_error_ozaria
          return noty({ text: 'Error in saving intro level session', type: 'error', timeout: 2000 })
        }
      },
      setCurrentContentId: function (content) {
        if (_.isObject(content.contentId)) {
          if (!content.contentId[this.language]) {
            console.error(`Intro content for language ${this.language} not found`)
            // TODO handle_error_ozaria
            noty({ text: 'Invalid intro content', type: 'error', timeout: 2000 })
            this.currentContentId = ''
            return
          }
          this.currentContentId = content.contentId[this.language]
        } else {
          this.currentContentId = content.contentId
        }
        // reload key is concatenated into child component's keys
        // so that we can trigger their re-render with the same content id by incrementing reloadKey
        // this is needed when `replay` is clicked on victory modal
        this.reloadKey[content.type] = this.reloadKey[content.type] || 0
        this.reloadKey[content.type]++
      },
      setIntroLevelComplete: async function () {
        if (this.introLevelSession) {
          this.introLevelSession.state = this.introLevelSession.state || {}
          this.introLevelSession.state.complete = true
        }
        await this.saveLevelSession()
      },
      updateContentPlaytime: function () {
        // Add 1 second to current content intro level session playtime count
        if (me.isSessionless()) return
        if (this.currentContent && this.introLevelSession) {
          // NOTE: character customization playtime currently added to content that launches it (e.g. 1st cutscene in 1fh)
          const contentId = _.isObject(this.currentContent.contentId) ? this.currentContent.contentId[this.language] : this.currentContent.contentId
          const type = this.currentContent.type
          this.introLevelSession.contentPlaytimes = this.introLevelSession.contentPlaytimes || []
          const currentPlaytime = this.introLevelSession.contentPlaytimes.find((cp) => {
            return contentId === cp.contentId && type === cp.type
          }) || { contentId, type }
          if (currentPlaytime.playtime) {
            currentPlaytime.playtime++
          } else {
            currentPlaytime.playtime = 1
            this.introLevelSession.contentPlaytimes.push(currentPlaytime)
          }
        } else {
          log(`No current content or levelSession for intro level ${this.introLevelIdOrSlug}`, { currentContent: this.currentContent, introLevelSession: this.introLevelSession }, 'error')
        }
      }
    }
  })
</script>

<template>
  <div v-if="dataLoaded">
    <interactives-component
      v-if="currentContent.type == 'interactive'"
      :key="currentContentId + `${reloadKey[currentContent.type]}`"
      :interactive-id-or-slug="currentContentId"
      :code-language="language"
      @completed="onContentCompleted"
    />
    <cinematics-component
      v-else-if="currentContent.type == 'cinematic'"
      :key="currentContentId + `${reloadKey[currentContent.type]}`"
      :cinematic-id-or-slug="currentContentId"
      :user-options="{ programmingLanguage: language }"
      @completed="onContentCompleted"
    />
    <cutscene-video-component
      v-else-if="currentContent.type == 'cutscene-video'"
      :key="currentContentId + `${reloadKey[currentContent.type]}`"
      :cutscene-id="currentContentId"
      @completed="onContentCompleted"
    />
    <avatar-selection-screen
      v-else-if="currentContent.type == 'avatarSelectionScreen'"
      @completed="onContentCompleted"
    />
    <modal-transition
      v-if="showVictoryModal"
      :campaign-handle="introLevelData.campaign"
      :current-level="introLevelData"
      :course-id="courseId"
      :course-instance-id="courseInstanceId"
      :current-intro-content="currentContentData"
      :intro-level-complete="introLevelComplete"
      @replay="onReplayVictoryModal"
      @next-content="goToNextContent"
    />
  </div>
</template>

<style lang="sass" scoped>
</style>
